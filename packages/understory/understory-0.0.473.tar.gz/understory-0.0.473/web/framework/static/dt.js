import{D as U,i as R,s as O,u as E,t as D,r as B,c as q,d as F,a as V,o as j,b as M,e as G,S as H}from"./vendor.1ff5a974.js";const K=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const r of t)if(r.type==="childList")for(const p of r.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&s(p)}).observe(document,{childList:!0,subtree:!0});function o(t){const r={};return t.integrity&&(r.integrity=t.integrity),t.referrerpolicy&&(r.referrerPolicy=t.referrerpolicy),t.crossorigin==="use-credentials"?r.credentials="include":t.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(t){if(t.ep)return;t.ep=!0;const r=o(t);fetch(t.href,r)}};K();const S=(n,e)=>{if(n.length!==e.length)return!1;for(let o=0;o<n.length;o++)if(n[o]!==e[o])return!1;return!0},I=n=>{if(!n)throw Error("Assertion failure")},P=(n=1e3)=>new Promise(e=>setTimeout(e,n)),z=(n,e)=>{if(n===e)return{pos:0,del:0,ins:""};let o=[...n],s=[...e];for(var t=0;o[t]===s[t];)t++;for(var r=0;o[o.length-1-r]===s[s.length-1-r]&&r+t<o.length&&r+t<s.length;)r++;const p=o.length!==t+r?o.length-t-r:0,w=s.length!==t+r?s.slice(t,s.length-r).join(""):"";return{pos:t,del:p,ins:w}},L=(n,{tag:e,start:o,end:s},t=!0)=>{let r=s-o;return n<o||n===o&&t?n:e==="Ins"?n+r:n<s?o:n-r},k=(n,e,o,s)=>{const t=L(n,e,o);t!==s&&(console.error("TEST FAILED",n,e,"is_left",o),console.error("  Expected:",s,"/ Actual:",t))},y=(n,e,o,s=o)=>{k(n,e,!0,o),k(n,e,!1,s)};y(10,{tag:"Ins",start:5,end:9},14);y(10,{tag:"Ins",start:8,end:12},14);y(10,{tag:"Ins",start:10,end:14},10,14);y(10,{tag:"Ins",start:11,end:15},10);y(10,{tag:"Del",start:5,end:9},6);y(10,{tag:"Del",start:6,end:10},6);y(10,{tag:"Del",start:6,end:100},6);y(10,{tag:"Del",start:60,end:100},10);y(10,{tag:"Del",start:10,end:100},10);window.Doc=U;const A="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_",Q=(n=12)=>Array.from(crypto.getRandomValues(new Uint8Array(n))).map(e=>A[e%A.length]).join(""),C=()=>{};async function W(n,e,o={}){await R();const s=o.setStatus??C,t=o.setInfo??C;let r=e.placeholder;e.placeholder="Loading...";const p={parseDoc(d,h){const l=Q();console.log("parseDoc",l);let u=U.fromBytes(h,l),f=u.getLocalVersion();return console.log("v",Array.from(f),"contents",JSON.stringify(u.get())),console.log([...u.get()]),[u,f]},applyPatch([d,h],l,u){let f=d.mergeBytes(u),v=d.mergeVersions(h,f);return[d,v]}};s("connecting");let w=await O(n,p);e.placeholder=r;const[i,a]=w.initialValue;let g=i.get(),c=a,m=c;const _=()=>{t(`${S(c,m)?"Up to date":"Versions differ!"}

local: ${JSON.stringify([...c])}
(${JSON.stringify(i.localToRemoteVersion(c))})

server: ${JSON.stringify([...m])}
(${JSON.stringify(i.localToRemoteVersion(m))})`)};_(),e.value=g,s("connected");const b=d=>{let h=i.getLocalVersion();if(S(h,c))return;m=d;let l=i.get(),{selectionStart:u,selectionEnd:f}=e;u=E.strPosToUni(g,u),f=E.strPosToUni(g,f);for(const v of i.xfSince(c))u=L(u,v,!0),f=L(f,v,!0);e.value=g=l,c=h,e.setSelectionRange(E.uniToStrPos(l,u),E.uniToStrPos(l,f)),I(S(i.getLocalVersion(),c)),_()};(async()=>{for(;;){for await(const d of w.updates)b(d.value[1]);for(console.warn("connection GONE");;){s("waiting"),await P(3e3),s("connecting");try{w=await O(n,{...p,knownDoc:[i,c],parseDoc(d,h){console.log("parseDoc reconnect");let l=i.mergeBytes(h);return m=l,[i,l]}}),b(w.initialValue[1]),console.log("reconnected!"),s("connected"),$();break}catch(d){console.warn("Could not reconnect:",d)}}}})();let T=!1,N=!1;const J=async()=>{I(S(i.getLocalVersion(),c));let d=c,h=i.getPatchSince(m);T=!0;try{if(n==="/api/data/wiki/delay"&&await P(3e3),(await fetch(n,{method:"PATCH",headers:{"content-type":"application/diamond-types"},redirect:"follow",body:h})).status>=400)throw Error("Network error");m=i.mergeVersions(m,d),T=!1,_(),$()}catch(l){console.error("Error flushing",l),T=!1,N||(setTimeout(()=>{N=!1,$()},3e3),N=!0)}};function $(){I(S(i.getLocalVersion(),c)),!T&&!S(m,c)&&J()}["textInput","keydown","keyup","select","cut","paste","input"].forEach(d=>{e.addEventListener(d,h=>{setTimeout(()=>{I(S(i.getLocalVersion(),c));let l=e.value;if(l!==g){let{pos:u,del:f,ins:v}=z(g,l.replace(/\r\n/g,`
`));f>0&&i.del(u,f),v!==""&&i.ins(u,v),c=i.getLocalVersion(),g=l,$(),_()}},0)},!1)})}const X=D('<div id="statusContainer"><div></div></div>'),Y=D('<textarea placeholder="Type here yo" autofocus></textarea>'),Z=D('<div id="info"></div>'),ee=D('<button id="showInfo">info</button>'),x=`wiki${location.pathname}`;console.log(`Editing ${x}`);const te=`/api/data/${x}`,ne=n=>{let e;const[o,s]=V("connecting"),[t,r]=V("Loading..."),[p,w]=V(!1),i=()=>w(!p());return j(()=>{W(te,e,{setStatus(a){console.log("STATUS",a),s(a)},setInfo:r})}),[(()=>{const a=X.cloneNode(!0),g=a.firstChild;return M(()=>g.className=o()),a})(),(()=>{const a=Y.cloneNode(!0),g=e;return typeof g=="function"?g(a):e=a,a})(),q(H,{get when(){return p()},get children(){const a=Z.cloneNode(!0);return G(a,t),a}}),(()=>{const a=ee.cloneNode(!0);return a.$$click=i,a})()]};B(()=>q(ne,{}),document.getElementById("root"));F(["click"]);
//# sourceMappingURL=index.fa883575.js.map
