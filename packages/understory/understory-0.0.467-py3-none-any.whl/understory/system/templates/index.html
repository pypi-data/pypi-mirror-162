$def with (app)
$# , understory_version, applications)
$var title: $app.name

<h2>Theme</h2>

<form action=/system/theme method=post>
$ action = "deactivate" if tx.host.theme else "activate"
<button name=action value=$action>$action.capitalize()</button>
</form>

<h2>Route Controllers</h2>

<ul id=controllers>
$for route, controller in app.controllers:
    <li>
        <a href=/$route>/$route</a><br>
        <small><strong><a class=controller href=https://understory.stream/api/$("/".join(controller.handler.__module__.split(".")))#$controller.handler.__name__>$controller.handler.__name__</a></strong></small>
    </li>
</ul>

<ul id=mounts>
$for prefix, subapp in sorted(app.mounts):
    $if subapp.controllers:
        <li><a href=/$prefix>/$prefix</a>
        $ root = subapp.controllers[0]
        $if root[0] == "":
            <br>
            <small><strong><a class=controller href=https://understory.stream/api/$("/".join(root[1].handler.__module__.split(".")))#$root[1].handler.__name__>$root[1].handler.__name__</a></strong></small>
            $:str(mkdn((root[1].__doc__.strip() + "\n").splitlines()[0])).removeprefix("<p>").removesuffix("</p>")
        <ul>
        $for route, controller in subapp.controllers[1:]:
            $ parts = re.split(r"\(\?P<(.+?)>(.+?)\)", route)
            <li>\
            $if len(parts) == 1:
                $if parts[0]:
                    <a href=/$prefix/$parts[0]>/$parts[0]</a>\
            $else:
                /\
                $for a, b, c in zip(parts[0::3], parts[1::3], parts[2::3]):
                    $:a.replace("(", '<span class="optional">')\
                    <label class=bounding><select required title="$c">\
                        <option value="" disabled selected hidden>$b</option>
                        <option value="0">0</option>
                        <option value="1">1</option>
                    </select></label>\
                $:parts[-1].replace(")?", "</span>")
                <button>Go</button>
            <br>
            <small><strong><a class=controller href=https://understory.stream/api/$("/".join(controller.handler.__module__.split(".")))#$controller.handler.__name__>$controller.handler.__name__</a></strong></small>
            $:str(mkdn((controller.__doc__.strip() + "\n").splitlines()[0])).removeprefix("<p>").removesuffix("</p>")
            </li>
        </ul>
        </li>
</ul>

<h3>Transaction Wrappers</h3>
<ul id=wrappers>
$for wrapper in app.wrappers:
    <li>$wrapper.__name__<br>
    <small>$wrapper.__module__</small></li>
</ul>

$def aside():
    <form action=/system/update method=post><button>Update</button></form>
    $# <h4><a href=/system/applications>Applications</a></h4>
    $# <ul id=applications>
    $# $for application in applications:
    $#     <li>$application.project_name<br>
    $#     <small>$application.version</small></li>
    $# </ul>
    $# <form method=post action=/system/applications>
    $#     <label><small>Application URL</small><br>
    $#     <label class=bounding><input type=text name=application_url
    $#     placeholder="github path, pypi path or .git url"></label></label>
    $#     <div class=buttons><button>Install</button></div>
    $# </form>
$var aside = aside

$# XXX <ul>
$# XXX $for prefix, subapp in app.mounts:
$# XXX     $if subapp.wrappers:
$# XXX         $for wrapper in subapp.wrappers:
$# XXX             <li>$wrapper</li>
$# XXX </ul>

<style>
ul#controllers, ul#mounts, ul#wrappers {
  list-style: none;
  padding-left: 0; }
ul#mounts > li {
  margin: 1em 0; }
ul#mounts > li li {
  margin: .5em 0; }
em {
  color: #586e75; }
select {
  border: 0; }
#mounts label.bounding {
  display: inline; }
a.controller {
  color: #b58900;
  font-family: mono;
  font-size: .9em;
  text-decoration: none; }
.optional {
  border-style: dotted;
  border-width: .2em; }
@media (prefers-color-scheme: light) {
  .optional {
    border-color: #93a1a1; }
}
@media (prefers-color-scheme: dark) {
  .optional {
    border-color: #586e75; }
}

#applications {
  font-size: .8em;
  list-style: none;
  padding-left: 0; }
</style>
