<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>eqcorrscan.utils.pre_processing &#8212; EQcorrscan 0.4.3 documentation</title>
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="shortcut icon" href="../../../_static/EQcorrscan_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.12.4.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.4.1/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html"><span><img src="../../../_static/EQcorrscan_logo.jpg"></span>
          EQcorrscan</a>
        <span class="navbar-text navbar-version pull-left"><b>0.4</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">1. Introduction to the EQcorrscan package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">2. EQcorrscan installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../updates.html">3. Whatâ€™s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">4. EQcorrscan tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">5. EQcorrscan API</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for eqcorrscan.utils.pre_processing</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Utilities module whose functions are designed to do the basic processing of</span>
<span class="sd">the data using obspy modules (which also rely on scipy and numpy).</span>

<span class="sd">:copyright:</span>
<span class="sd">    EQcorrscan developers.</span>

<span class="sd">:license:</span>
<span class="sd">    GNU Lesser General Public License, Version 3</span>
<span class="sd">    (https://www.gnu.org/copyleft/lesser.html)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">cpu_count</span>

<span class="kn">from</span> <span class="nn">obspy</span> <span class="kn">import</span> <span class="n">Stream</span><span class="p">,</span> <span class="n">Trace</span><span class="p">,</span> <span class="n">UTCDateTime</span>
<span class="kn">from</span> <span class="nn">obspy.core.trace</span> <span class="kn">import</span> <span class="n">Stats</span>
<span class="kn">from</span> <span class="nn">obspy.signal.filter</span> <span class="kn">import</span> <span class="n">bandpass</span><span class="p">,</span> <span class="n">lowpass</span><span class="p">,</span> <span class="n">highpass</span>


<span class="n">Logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_daylong</span><span class="p">(</span><span class="n">tr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check the data quality of the daylong file.</span>

<span class="sd">    Check to see that the day isn&#39;t just zeros, with large steps, if it is</span>
<span class="sd">    then the resampling will hate it.</span>

<span class="sd">    :type tr: obspy.core.trace.Trace</span>
<span class="sd">    :param tr: Trace to check if the data are daylong.</span>

<span class="sd">    :return quality (simply good or bad)</span>
<span class="sd">    :rtype: bool</span>

<span class="sd">    .. rubric:: Example</span>

<span class="sd">    &gt;&gt;&gt; from obspy import read</span>
<span class="sd">    &gt;&gt;&gt; from eqcorrscan.utils.pre_processing import _check_daylong</span>
<span class="sd">    &gt;&gt;&gt; # Get the path to the test data</span>
<span class="sd">    &gt;&gt;&gt; import eqcorrscan</span>
<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; TEST_PATH = os.path.dirname(eqcorrscan.__file__) + &#39;/tests/test_data&#39;</span>
<span class="sd">    &gt;&gt;&gt; st = read(TEST_PATH + &#39;/WAV/TEST_/&#39; +</span>
<span class="sd">    ...           &#39;2013-09-01-0410-35.DFDPC_024_00&#39;)</span>
<span class="sd">    &gt;&gt;&gt; _check_daylong(st[0])</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
        <span class="n">qual</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">qual</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">qual</span>


<div class="viewcode-block" id="shortproc"><a class="viewcode-back" href="../../../submodules/autogen/eqcorrscan.utils.pre_processing.shortproc.html#eqcorrscan.utils.pre_processing.shortproc">[docs]</a><span class="k">def</span> <span class="nf">shortproc</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">lowcut</span><span class="p">,</span> <span class="n">highcut</span><span class="p">,</span> <span class="n">filt_order</span><span class="p">,</span> <span class="n">samp_rate</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">num_cores</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">starttime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endtime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">seisan_chan_names</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_gaps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_length</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">ignore_bad_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fft_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Basic function to bandpass and downsample.</span>

<span class="sd">    Works in place on data.  This is employed to ensure all parts of the</span>
<span class="sd">    data are processed in the same way.</span>

<span class="sd">    :type st: obspy.core.stream.Stream</span>
<span class="sd">    :param st: Stream to process</span>
<span class="sd">    :type lowcut: float</span>
<span class="sd">    :param lowcut: Low cut for bandpass in Hz</span>
<span class="sd">    :type highcut: float</span>
<span class="sd">    :param highcut: High cut for bandpass in Hz</span>
<span class="sd">    :type filt_order: int</span>
<span class="sd">    :param filt_order: Number of corners for bandpass filter</span>
<span class="sd">    :type samp_rate: float</span>
<span class="sd">    :param samp_rate: Sampling rate desired in Hz</span>
<span class="sd">    :type parallel: bool</span>
<span class="sd">    :param parallel:</span>
<span class="sd">        Set to True to process traces in parallel, for small numbers of traces</span>
<span class="sd">        this is often slower than serial processing, defaults to False</span>
<span class="sd">    :type num_cores: int</span>
<span class="sd">    :param num_cores:</span>
<span class="sd">        Control the number of cores for parallel processing, if set to False</span>
<span class="sd">        then this will use all the cores available.</span>
<span class="sd">    :type starttime: obspy.core.utcdatetime.UTCDateTime</span>
<span class="sd">    :param starttime:</span>
<span class="sd">        Desired data start time, will trim to this before processing</span>
<span class="sd">    :type endtime: obspy.core.utcdatetime.UTCDateTime</span>
<span class="sd">    :param endtime:</span>
<span class="sd">        Desired data end time, will trim to this before processing</span>
<span class="sd">    :type seisan_chan_names: bool</span>
<span class="sd">    :param seisan_chan_names:</span>
<span class="sd">        Whether channels are named like seisan channels (which are two letters</span>
<span class="sd">        rather than SEED convention of three) - defaults to True.</span>
<span class="sd">    :type fill_gaps: bool</span>
<span class="sd">    :param fill_gaps: Whether to pad any gaps found with zeros or not.</span>
<span class="sd">    :type ignore_length: bool</span>
<span class="sd">    :param ignore_length:</span>
<span class="sd">        Whether to allow data that are less than 80% of the requested length.</span>
<span class="sd">        Defaults to False which will error if short data are found.</span>
<span class="sd">    :type ignore_bad_data: bool</span>
<span class="sd">    :param ignore_bad_data:</span>
<span class="sd">        If False (default), errors will be raised if data are excessively</span>
<span class="sd">        gappy or are mostly zeros. If True then no error will be raised, but</span>
<span class="sd">        an empty trace will be returned.</span>
<span class="sd">    :type fft_threads: int</span>
<span class="sd">    :param fft_threads:</span>
<span class="sd">        Number of threads to use for pyFFTW FFT in resampling. Note that it</span>
<span class="sd">        is not recommended to use fft_threads &gt; 1 and num_cores &gt; 1.</span>


<span class="sd">    :return: Processed stream</span>
<span class="sd">    :rtype: :class:`obspy.core.stream.Stream`</span>

<span class="sd">    .. note::</span>
<span class="sd">        If your data contain gaps you should *NOT* fill those gaps before</span>
<span class="sd">        using the pre-process functions. The pre-process functions will fill</span>
<span class="sd">        the gaps internally prior to processing, process the data, then re-fill</span>
<span class="sd">        the gaps with zeros to ensure correlations are not incorrectly</span>
<span class="sd">        calculated within gaps. If your data have gaps you should pass a merged</span>
<span class="sd">        stream without the `fill_value` argument (e.g.: `st = st.merge()`).</span>

<span class="sd">    .. warning::</span>
<span class="sd">        If you intend to use this for processing templates you should consider</span>
<span class="sd">        how resampling will impact your cross-correlations. Minor differences</span>
<span class="sd">        in resampling between day-long files (which you are likely to use for</span>
<span class="sd">        continuous detection) and shorter files will reduce your</span>
<span class="sd">        cross-correlations!</span>

<span class="sd">    .. rubric:: Example, bandpass</span>

<span class="sd">    &gt;&gt;&gt; from obspy import read</span>
<span class="sd">    &gt;&gt;&gt; from eqcorrscan.utils.pre_processing import shortproc</span>
<span class="sd">    &gt;&gt;&gt; # Get the path to the test data</span>
<span class="sd">    &gt;&gt;&gt; import eqcorrscan</span>
<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; TEST_PATH = os.path.dirname(eqcorrscan.__file__) + &#39;/tests/test_data&#39;</span>
<span class="sd">    &gt;&gt;&gt; st = read(TEST_PATH + &#39;/WAV/TEST_/2013-09-01-0410-35.DFDPC_024_00&#39;)</span>
<span class="sd">    &gt;&gt;&gt; st = shortproc(st=st, lowcut=2, highcut=9, filt_order=3, samp_rate=20,</span>
<span class="sd">    ...                parallel=True, num_cores=2)</span>
<span class="sd">    &gt;&gt;&gt; print(st[0])</span>
<span class="sd">    AF.LABE..SHZ | 2013-09-01T04:10:35.700000Z - 2013-09-01T04:12:05.650000Z \</span>
<span class="sd">| 20.0 Hz, 1800 samples</span>

<span class="sd">    .. rubric:: Example, low-pass</span>

<span class="sd">    &gt;&gt;&gt; from obspy import read</span>
<span class="sd">    &gt;&gt;&gt; from eqcorrscan.utils.pre_processing import shortproc</span>
<span class="sd">    &gt;&gt;&gt; # Get the path to the test data</span>
<span class="sd">    &gt;&gt;&gt; import eqcorrscan</span>
<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; TEST_PATH = os.path.dirname(eqcorrscan.__file__) + &#39;/tests/test_data&#39;</span>
<span class="sd">    &gt;&gt;&gt; st = read(TEST_PATH + &#39;/WAV/TEST_/2013-09-01-0410-35.DFDPC_024_00&#39;)</span>
<span class="sd">    &gt;&gt;&gt; st = shortproc(st=st, lowcut=None, highcut=9, filt_order=3,</span>
<span class="sd">    ...                samp_rate=20)</span>
<span class="sd">    &gt;&gt;&gt; print(st[0])</span>
<span class="sd">    AF.LABE..SHZ | 2013-09-01T04:10:35.700000Z - 2013-09-01T04:12:05.650000Z \</span>
<span class="sd">| 20.0 Hz, 1800 samples</span>

<span class="sd">    .. rubric:: Example, high-pass</span>

<span class="sd">    &gt;&gt;&gt; from obspy import read</span>
<span class="sd">    &gt;&gt;&gt; from eqcorrscan.utils.pre_processing import shortproc</span>
<span class="sd">    &gt;&gt;&gt; # Get the path to the test data</span>
<span class="sd">    &gt;&gt;&gt; import eqcorrscan</span>
<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; TEST_PATH = os.path.dirname(eqcorrscan.__file__) + &#39;/tests/test_data&#39;</span>
<span class="sd">    &gt;&gt;&gt; st = read(TEST_PATH + &#39;/WAV/TEST_/2013-09-01-0410-35.DFDPC_024_00&#39;)</span>
<span class="sd">    &gt;&gt;&gt; st = shortproc(st=st, lowcut=2, highcut=None, filt_order=3,</span>
<span class="sd">    ...                samp_rate=20)</span>
<span class="sd">    &gt;&gt;&gt; print(st[0])</span>
<span class="sd">    AF.LABE..SHZ | 2013-09-01T04:10:35.700000Z - 2013-09-01T04:12:05.650000Z \</span>
<span class="sd">| 20.0 Hz, 1800 samples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">Trace</span><span class="p">):</span>
        <span class="n">tracein</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tracein</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Add sanity check for filter</span>
    <span class="k">if</span> <span class="n">highcut</span> <span class="ow">and</span> <span class="n">highcut</span> <span class="o">&gt;=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">samp_rate</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Highcut must be lower than the nyquist&#39;</span><span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">clip</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">starttime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">endtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="p">,</span> <span class="n">endtime</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="p">((</span><span class="n">endtime</span> <span class="o">-</span> <span class="n">starttime</span><span class="p">)</span> <span class="o">*</span>
                                <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">)]</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">endtime</span> <span class="o">-</span> <span class="n">starttime</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">starttime</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">starttime</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">endtime</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">endtime</span><span class="o">=</span><span class="n">endtime</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
            <span class="n">Logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No data for </span><span class="si">{0}</span><span class="s1"> after trim&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">num_cores</span><span class="p">:</span>
            <span class="n">num_cores</span> <span class="o">=</span> <span class="n">cpu_count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">num_cores</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">):</span>
            <span class="n">num_cores</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">num_cores</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="p">(</span><span class="n">tr</span><span class="p">,),</span> <span class="p">{</span>
            <span class="s1">&#39;lowcut&#39;</span><span class="p">:</span> <span class="n">lowcut</span><span class="p">,</span> <span class="s1">&#39;highcut&#39;</span><span class="p">:</span> <span class="n">highcut</span><span class="p">,</span> <span class="s1">&#39;filt_order&#39;</span><span class="p">:</span> <span class="n">filt_order</span><span class="p">,</span>
            <span class="s1">&#39;samp_rate&#39;</span><span class="p">:</span> <span class="n">samp_rate</span><span class="p">,</span> <span class="s1">&#39;starttime&#39;</span><span class="p">:</span> <span class="n">starttime</span><span class="p">,</span>
            <span class="s1">&#39;clip&#39;</span><span class="p">:</span> <span class="n">clip</span><span class="p">,</span> <span class="s1">&#39;seisan_chan_names&#39;</span><span class="p">:</span> <span class="n">seisan_chan_names</span><span class="p">,</span>
            <span class="s1">&#39;fill_gaps&#39;</span><span class="p">:</span> <span class="n">fill_gaps</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="n">length</span><span class="p">,</span>
            <span class="s1">&#39;ignore_length&#39;</span><span class="p">:</span> <span class="n">ignore_length</span><span class="p">,</span> <span class="s1">&#39;fft_threads&#39;</span><span class="p">:</span> <span class="n">fft_threads</span><span class="p">,</span>
            <span class="s1">&#39;ignore_bad_data&#39;</span><span class="p">:</span> <span class="n">ignore_bad_data</span><span class="p">})</span>
                   <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st</span><span class="p">]</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stream_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">(</span><span class="n">stream_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">st</span><span class="p">):</span>
            <span class="n">st</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span>
                <span class="n">tr</span><span class="o">=</span><span class="n">tr</span><span class="p">,</span> <span class="n">lowcut</span><span class="o">=</span><span class="n">lowcut</span><span class="p">,</span> <span class="n">highcut</span><span class="o">=</span><span class="n">highcut</span><span class="p">,</span> <span class="n">filt_order</span><span class="o">=</span><span class="n">filt_order</span><span class="p">,</span>
                <span class="n">samp_rate</span><span class="o">=</span><span class="n">samp_rate</span><span class="p">,</span> <span class="n">starttime</span><span class="o">=</span><span class="n">starttime</span><span class="p">,</span>
                <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span> <span class="n">seisan_chan_names</span><span class="o">=</span><span class="n">seisan_chan_names</span><span class="p">,</span>
                <span class="n">fill_gaps</span><span class="o">=</span><span class="n">fill_gaps</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span>
                <span class="n">ignore_length</span><span class="o">=</span><span class="n">ignore_length</span><span class="p">,</span> <span class="n">ignore_bad_data</span><span class="o">=</span><span class="n">ignore_bad_data</span><span class="p">,</span>
                <span class="n">fft_threads</span><span class="o">=</span><span class="n">fft_threads</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tracein</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">st</span></div>


<div class="viewcode-block" id="dayproc"><a class="viewcode-back" href="../../../submodules/autogen/eqcorrscan.utils.pre_processing.dayproc.html#eqcorrscan.utils.pre_processing.dayproc">[docs]</a><span class="k">def</span> <span class="nf">dayproc</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">lowcut</span><span class="p">,</span> <span class="n">highcut</span><span class="p">,</span> <span class="n">filt_order</span><span class="p">,</span> <span class="n">samp_rate</span><span class="p">,</span> <span class="n">starttime</span><span class="p">,</span>
            <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_cores</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ignore_length</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">seisan_chan_names</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_gaps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_bad_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">fft_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper for dayproc to parallel multiple traces in a stream.</span>

<span class="sd">    Works in place on data.  This is employed to ensure all parts of the data \</span>
<span class="sd">    are processed in the same way.</span>

<span class="sd">    :type st: obspy.core.stream.Stream</span>
<span class="sd">    :param st: Stream to process (can be trace).</span>
<span class="sd">    :type lowcut: float</span>
<span class="sd">    :param lowcut: Low cut in Hz for bandpass.</span>
<span class="sd">    :type highcut: float</span>
<span class="sd">    :param highcut: High cut in Hz for bandpass.</span>
<span class="sd">    :type filt_order: int</span>
<span class="sd">    :param filt_order: Corners for bandpass.</span>
<span class="sd">    :type samp_rate: float</span>
<span class="sd">    :param samp_rate: Desired sampling rate in Hz.</span>
<span class="sd">    :type starttime: obspy.core.utcdatetime.UTCDateTime</span>
<span class="sd">    :param starttime: Desired start-date of trace.</span>
<span class="sd">    :type parallel: bool</span>
<span class="sd">    :param parallel:</span>
<span class="sd">        Set to True to process traces in parallel, this is often faster than</span>
<span class="sd">        serial processing of traces: defaults to True.</span>
<span class="sd">    :type num_cores: int</span>
<span class="sd">    :param num_cores:</span>
<span class="sd">        Control the number of cores for parallel processing, if set to False</span>
<span class="sd">        then this will use all the cores.</span>
<span class="sd">    :type ignore_length: bool</span>
<span class="sd">    :param ignore_length: See warning below.</span>
<span class="sd">    :type seisan_chan_names: bool</span>
<span class="sd">    :param seisan_chan_names:</span>
<span class="sd">        Whether channels are named like seisan channels (which are two letters</span>
<span class="sd">        rather than SEED convention of three) - defaults to True.</span>
<span class="sd">    :type fill_gaps: bool</span>
<span class="sd">    :param fill_gaps: Whether to pad any gaps found with zeros or not.</span>
<span class="sd">    :type ignore_bad_data: bool</span>
<span class="sd">    :param ignore_bad_data:</span>
<span class="sd">        If False (default), errors will be raised if data are excessively</span>
<span class="sd">        gappy or are mostly zeros. If True then no error will be raised, but</span>
<span class="sd">        an empty trace will be returned.</span>
<span class="sd">    :type fft_threads: int</span>
<span class="sd">    :param fft_threads:</span>
<span class="sd">        Number of threads to use for pyFFTW FFT in resampling. Note that it</span>
<span class="sd">        is not recommended to use fft_threads &gt; 1 and num_cores &gt; 1.</span>

<span class="sd">    :return: Processed stream.</span>
<span class="sd">    :rtype: :class:`obspy.core.stream.Stream`</span>

<span class="sd">    .. note::</span>
<span class="sd">        If your data contain gaps you should *NOT* fill those gaps before</span>
<span class="sd">        using the pre-process functions. The pre-process functions will fill</span>
<span class="sd">        the gaps internally prior to processing, process the data, then re-fill</span>
<span class="sd">        the gaps with zeros to ensure correlations are not incorrectly</span>
<span class="sd">        calculated within gaps. If your data have gaps you should pass a merged</span>
<span class="sd">        stream without the `fill_value` argument (e.g.: `st = st.merge()`).</span>

<span class="sd">    .. warning::</span>
<span class="sd">        Will fail if data are less than 19.2 hours long - this number is</span>
<span class="sd">        arbitrary and is chosen to alert the user to the dangers of padding</span>
<span class="sd">        to day-long, if you don&#39;t care you can ignore this error by setting</span>
<span class="sd">        `ignore_length=True`. Use this option at your own risk!  It will also</span>
<span class="sd">        warn any-time it has to pad data - if you see strange artifacts in your</span>
<span class="sd">        detections, check whether the data have gaps.</span>

<span class="sd">    .. rubric:: Example</span>

<span class="sd">    &gt;&gt;&gt; import obspy</span>
<span class="sd">    &gt;&gt;&gt; if int(obspy.__version__.split(&#39;.&#39;)[0]) &gt;= 1:</span>
<span class="sd">    ...     from obspy.clients.fdsn import Client</span>
<span class="sd">    ... else:</span>
<span class="sd">    ...     from obspy.fdsn import Client</span>
<span class="sd">    &gt;&gt;&gt; from obspy import UTCDateTime</span>
<span class="sd">    &gt;&gt;&gt; from eqcorrscan.utils.pre_processing import dayproc</span>
<span class="sd">    &gt;&gt;&gt; client = Client(&#39;NCEDC&#39;)</span>
<span class="sd">    &gt;&gt;&gt; t1 = UTCDateTime(2012, 3, 26)</span>
<span class="sd">    &gt;&gt;&gt; t2 = t1 + 86400</span>
<span class="sd">    &gt;&gt;&gt; bulk_info = [(&#39;BP&#39;, &#39;JCNB&#39;, &#39;40&#39;, &#39;SP1&#39;, t1, t2)]</span>
<span class="sd">    &gt;&gt;&gt; st = client.get_waveforms_bulk(bulk_info)</span>
<span class="sd">    &gt;&gt;&gt; st_keep = st.copy()  # Copy the stream for later examples</span>
<span class="sd">    &gt;&gt;&gt; # Example of bandpass filtering</span>
<span class="sd">    &gt;&gt;&gt; st = dayproc(st=st, lowcut=2, highcut=9, filt_order=3, samp_rate=20,</span>
<span class="sd">    ...              starttime=t1, parallel=True, num_cores=2)</span>
<span class="sd">    &gt;&gt;&gt; print(st[0])</span>
<span class="sd">    BP.JCNB.40.SP1 | 2012-03-26T00:00:00.000000Z - 2012-03-26T23:59:59.\</span>
<span class="sd">950000Z | 20.0 Hz, 1728000 samples</span>
<span class="sd">    &gt;&gt;&gt; # Example of lowpass filtering</span>
<span class="sd">    &gt;&gt;&gt; st = dayproc(st=st, lowcut=None, highcut=9, filt_order=3, samp_rate=20,</span>
<span class="sd">    ...              starttime=t1, parallel=True, num_cores=2)</span>
<span class="sd">    &gt;&gt;&gt; print(st[0])</span>
<span class="sd">    BP.JCNB.40.SP1 | 2012-03-26T00:00:00.000000Z - 2012-03-26T23:59:59.\</span>
<span class="sd">950000Z | 20.0 Hz, 1728000 samples</span>
<span class="sd">    &gt;&gt;&gt; # Example of highpass filtering</span>
<span class="sd">    &gt;&gt;&gt; st = dayproc(st=st, lowcut=2, highcut=None, filt_order=3, samp_rate=20,</span>
<span class="sd">    ...              starttime=t1, parallel=True, num_cores=2)</span>
<span class="sd">    &gt;&gt;&gt; print(st[0])</span>
<span class="sd">    BP.JCNB.40.SP1 | 2012-03-26T00:00:00.000000Z - 2012-03-26T23:59:59.\</span>
<span class="sd">950000Z | 20.0 Hz, 1728000 samples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add sanity check for filter</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">Trace</span><span class="p">):</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
        <span class="n">tracein</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tracein</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">highcut</span> <span class="ow">and</span> <span class="n">highcut</span> <span class="o">&gt;=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">samp_rate</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Highcut must be lower than the nyquist&#39;</span><span class="p">)</span>
    <span class="c1"># Set the start-time to a day start - cope with</span>
    <span class="k">if</span> <span class="n">starttime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">startdates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">-</span> <span class="p">(</span><span class="n">UTCDateTime</span><span class="p">(</span>
                    <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="o">+</span> <span class="mi">86400</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
                <span class="c1"># If the trace starts within 1 sample of the next day, use the</span>
                <span class="c1"># next day as the startdate</span>
                <span class="n">startdates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">+</span> <span class="mi">86400</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
                <span class="n">Logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> starts within 1 sample of the next day, using this &#39;</span>
                    <span class="s1">&#39;time </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">tr</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">+</span> <span class="mi">86400</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">startdates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="c1"># Check that all traces start on the same date...</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">startdates</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Traces start on different days&#39;</span><span class="p">)</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="n">startdates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">num_cores</span><span class="p">:</span>
            <span class="n">num_cores</span> <span class="o">=</span> <span class="n">cpu_count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">num_cores</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">):</span>
            <span class="n">num_cores</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">num_cores</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="p">(</span><span class="n">tr</span><span class="p">,),</span> <span class="p">{</span>
            <span class="s1">&#39;lowcut&#39;</span><span class="p">:</span> <span class="n">lowcut</span><span class="p">,</span> <span class="s1">&#39;highcut&#39;</span><span class="p">:</span> <span class="n">highcut</span><span class="p">,</span> <span class="s1">&#39;filt_order&#39;</span><span class="p">:</span> <span class="n">filt_order</span><span class="p">,</span>
            <span class="s1">&#39;samp_rate&#39;</span><span class="p">:</span> <span class="n">samp_rate</span><span class="p">,</span> <span class="s1">&#39;starttime&#39;</span><span class="p">:</span> <span class="n">starttime</span><span class="p">,</span> <span class="s1">&#39;clip&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;ignore_length&#39;</span><span class="p">:</span> <span class="n">ignore_length</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="mi">86400</span><span class="p">,</span>
            <span class="s1">&#39;seisan_chan_names&#39;</span><span class="p">:</span> <span class="n">seisan_chan_names</span><span class="p">,</span> <span class="s1">&#39;fill_gaps&#39;</span><span class="p">:</span> <span class="n">fill_gaps</span><span class="p">,</span>
            <span class="s1">&#39;ignore_bad_data&#39;</span><span class="p">:</span> <span class="n">ignore_bad_data</span><span class="p">,</span> <span class="s1">&#39;fft_threads&#39;</span><span class="p">:</span> <span class="n">fft_threads</span><span class="p">})</span>
                   <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st</span><span class="p">]</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stream_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">(</span><span class="n">stream_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">st</span><span class="p">):</span>
            <span class="n">st</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span>
                <span class="n">tr</span><span class="o">=</span><span class="n">tr</span><span class="p">,</span> <span class="n">lowcut</span><span class="o">=</span><span class="n">lowcut</span><span class="p">,</span> <span class="n">highcut</span><span class="o">=</span><span class="n">highcut</span><span class="p">,</span> <span class="n">filt_order</span><span class="o">=</span><span class="n">filt_order</span><span class="p">,</span>
                <span class="n">samp_rate</span><span class="o">=</span><span class="n">samp_rate</span><span class="p">,</span> <span class="n">starttime</span><span class="o">=</span><span class="n">starttime</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">length</span><span class="o">=</span><span class="mi">86400</span><span class="p">,</span> <span class="n">ignore_length</span><span class="o">=</span><span class="n">ignore_length</span><span class="p">,</span>
                <span class="n">seisan_chan_names</span><span class="o">=</span><span class="n">seisan_chan_names</span><span class="p">,</span> <span class="n">fill_gaps</span><span class="o">=</span><span class="n">fill_gaps</span><span class="p">,</span>
                <span class="n">ignore_bad_data</span><span class="o">=</span><span class="n">ignore_bad_data</span><span class="p">,</span> <span class="n">fft_threads</span><span class="o">=</span><span class="n">fft_threads</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tracein</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">st</span></div>


<div class="viewcode-block" id="process"><a class="viewcode-back" href="../../../submodules/autogen/eqcorrscan.utils.pre_processing.process.html#eqcorrscan.utils.pre_processing.process">[docs]</a><span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">lowcut</span><span class="p">,</span> <span class="n">highcut</span><span class="p">,</span> <span class="n">filt_order</span><span class="p">,</span> <span class="n">samp_rate</span><span class="p">,</span>
            <span class="n">starttime</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">86400</span><span class="p">,</span>
            <span class="n">seisan_chan_names</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ignore_length</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_gaps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ignore_bad_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fft_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Basic function to process data, usually called by dayproc or shortproc.</span>

<span class="sd">    Functionally, this will bandpass, downsample and check headers and length</span>
<span class="sd">    of trace to ensure files start when they should and are the correct length.</span>
<span class="sd">    This is a simple wrapper on obspy functions, we include it here to provide</span>
<span class="sd">    a system to ensure all parts of the dataset are processed in the same way.</span>

<span class="sd">    .. note:: Usually this function is called via dayproc or shortproc.</span>

<span class="sd">    :type tr: obspy.core.trace.Trace</span>
<span class="sd">    :param tr: Trace to process</span>
<span class="sd">    :type lowcut: float</span>
<span class="sd">    :param lowcut:</span>
<span class="sd">        Low cut in Hz, if set to None and highcut is set, will use</span>
<span class="sd">        a lowpass filter.</span>
<span class="sd">    :type highcut: float</span>
<span class="sd">    :param highcut:</span>
<span class="sd">        High cut in Hz, if set to None and lowcut is set, will use</span>
<span class="sd">        a highpass filter.</span>
<span class="sd">    :type filt_order: int</span>
<span class="sd">    :param filt_order: Number of corners for filter.</span>
<span class="sd">    :type samp_rate: float</span>
<span class="sd">    :param samp_rate: Desired sampling rate in Hz.</span>
<span class="sd">    :type starttime: obspy.core.utcdatetime.UTCDateTime</span>
<span class="sd">    :param starttime: Desired start of trace</span>
<span class="sd">    :type clip: bool</span>
<span class="sd">    :param clip: Whether to expect, and enforce a set length of data or not.</span>
<span class="sd">    :type length: float</span>
<span class="sd">    :param length: Use to set a fixed length for data from the given starttime.</span>
<span class="sd">    :type seisan_chan_names: bool</span>
<span class="sd">    :param seisan_chan_names:</span>
<span class="sd">        Whether channels are named like seisan channels (which are two letters</span>
<span class="sd">        rather than SEED convention of three) - defaults to True.</span>
<span class="sd">    :type ignore_length: bool</span>
<span class="sd">    :param ignore_length: See warning in dayproc.</span>
<span class="sd">    :type fill_gaps: bool</span>
<span class="sd">    :param fill_gaps: Whether to pad any gaps found with zeros or not.</span>
<span class="sd">    :type ignore_bad_data: bool</span>
<span class="sd">    :param ignore_bad_data:</span>
<span class="sd">        If False (default), errors will be raised if data are excessively</span>
<span class="sd">        gappy or are mostly zeros. If True then no error will be raised, but</span>
<span class="sd">        an empty trace will be returned.</span>
<span class="sd">    :type fft_threads: int</span>
<span class="sd">    :param fft_threads: Number of threads to use for pyFFTW FFT in resampling</span>

<span class="sd">    :return: Processed trace.</span>
<span class="sd">    :type: :class:`obspy.core.stream.Trace`</span>

<span class="sd">    .. note::</span>
<span class="sd">        If your data contain gaps you should *NOT* fill those gaps before</span>
<span class="sd">        using the pre-process functions. The pre-process functions will fill</span>
<span class="sd">        the gaps internally prior to processing, process the data, then re-fill</span>
<span class="sd">        the gaps with zeros to ensure correlations are not incorrectly</span>
<span class="sd">        calculated within gaps. If your data have gaps you should pass a merged</span>
<span class="sd">        stream without the `fill_value` argument (e.g.: `tr = tr.merge()`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add sanity check</span>
    <span class="k">if</span> <span class="n">highcut</span> <span class="ow">and</span> <span class="n">highcut</span> <span class="o">&gt;=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">samp_rate</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Highcut must be lower than the nyquist&#39;</span><span class="p">)</span>

    <span class="c1"># Define the start-time</span>
    <span class="k">if</span> <span class="n">starttime</span><span class="p">:</span>
        <span class="c1"># Be nice and allow a datetime object.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">starttime</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">starttime</span><span class="p">,</span>
                                                        <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="n">starttime</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="n">starttime</span><span class="p">)</span>

    <span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Working on: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="c1"># Check if the trace is gappy and pad if it is.</span>
    <span class="n">gappy</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">):</span>
        <span class="n">gappy</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">gaps</span><span class="p">,</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">_fill_gaps</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="c1"># Do a brute force quality check</span>
    <span class="n">qual</span> <span class="o">=</span> <span class="n">_check_daylong</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">qual</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Data have more zeros than actual data, please check the raw&quot;</span><span class="p">,</span>
               <span class="s2">&quot; data set-up and manually sort it: &quot;</span> <span class="o">+</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span>
               <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_bad_data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">header</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;station&quot;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="s2">&quot;channel&quot;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span>
                <span class="s2">&quot;network&quot;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
                <span class="s2">&quot;starttime&quot;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">,</span>
                <span class="s2">&quot;sampling_rate&quot;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">})</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="s1">&#39;simple&#39;</span><span class="p">)</span>
    <span class="c1"># Detrend data before filtering</span>
    <span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;I have </span><span class="si">{0}</span><span class="s1"> data points for </span><span class="si">{1}</span><span class="s1"> before processing&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

    <span class="c1"># Sanity check to ensure files are daylong</span>
    <span class="n">padded</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">clip</span><span class="p">:</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="p">,</span> <span class="n">starttime</span> <span class="o">+</span> <span class="n">length</span><span class="p">,</span> <span class="n">nearest_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span> <span class="o">/</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">)</span> <span class="o">!=</span> <span class="n">length</span> <span class="ow">and</span> <span class="n">clip</span><span class="p">:</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Data for </span><span class="si">{0}</span><span class="s1"> are not long-enough, will zero pad&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">tr</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="o">-</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">&lt;</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="n">length</span>\
           <span class="ow">and</span> <span class="ow">not</span> <span class="n">ignore_length</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Data for </span><span class="si">{0}</span><span class="s2">.</span><span class="si">{1}</span><span class="s2"> is </span><span class="si">{2:.2f}</span><span class="s2"> seconds long, which is less than &quot;</span>
                <span class="s2">&quot;80 percent of the desired length (</span><span class="si">{3}</span><span class="s2"> seconds), will not &quot;</span>
                <span class="s2">&quot;pad&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span>
                    <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="o">-</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_bad_data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">Trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">header</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;station&quot;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="s2">&quot;channel&quot;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span>
                    <span class="s2">&quot;network&quot;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
                    <span class="s2">&quot;starttime&quot;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">,</span>
                    <span class="s2">&quot;sampling_rate&quot;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">})</span>
        <span class="c1"># trim, then calculate length of any pads required</span>
        <span class="n">pre_pad_secs</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">-</span> <span class="n">starttime</span>
        <span class="n">post_pad_secs</span> <span class="o">=</span> <span class="p">(</span><span class="n">starttime</span> <span class="o">+</span> <span class="n">length</span><span class="p">)</span> <span class="o">-</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span>
        <span class="k">if</span> <span class="n">pre_pad_secs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">post_pad_secs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">padded</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">pre_pad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pre_pad_secs</span> <span class="o">*</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">))</span>
            <span class="n">post_pad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">post_pad_secs</span> <span class="o">*</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">))</span>
            <span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tr</span><span class="p">))</span>
            <span class="n">Logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Padding to length with </span><span class="si">{0}</span><span class="s2"> s before and </span><span class="si">{1}</span><span class="s2"> s &quot;</span>
                        <span class="s2">&quot;at end&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_pad_secs</span><span class="p">,</span> <span class="n">post_pad_secs</span><span class="p">))</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">pre_pad</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">post_pad</span><span class="p">])</span>
            <span class="c1"># Use this rather than the expected pad because of rounding samples</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pre_pad</span><span class="p">)</span> <span class="o">*</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span>
            <span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tr</span><span class="p">))</span>
        <span class="c1"># If there is one sample too many after this remove the first one</span>
        <span class="c1"># by convention</span>
        <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span> <span class="o">==</span> <span class="p">(</span><span class="n">length</span> <span class="o">*</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">)]</span>
        <span class="c1"># Cope with time precision.</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">((</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span> <span class="o">-</span>
               <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Data sampling-rate * length (</span><span class="si">{0}</span><span class="s2"> * </span><span class="si">{1}</span><span class="s2"> = </span><span class="si">{2}</span><span class="s2">) does not &quot;</span>
                   <span class="s2">&quot;match number of samples (</span><span class="si">{3}</span><span class="s2">) for </span><span class="si">{4}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
                    <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="o">*</span> <span class="n">length</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_bad_data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">Trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">header</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;station&quot;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="s2">&quot;channel&quot;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span>
                    <span class="s2">&quot;network&quot;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
                    <span class="s2">&quot;starttime&quot;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">,</span>
                    <span class="s2">&quot;sampling_rate&quot;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">})</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;I now have </span><span class="si">{0}</span><span class="s1"> data points after enforcing length&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span><span class="p">))</span>
    <span class="c1"># Check sampling rate and resample</span>
    <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="o">!=</span> <span class="n">samp_rate</span><span class="p">:</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Resampling&#39;</span><span class="p">)</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">_resample</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">samp_rate</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="n">fft_threads</span><span class="p">)</span>
    <span class="c1"># Filtering section</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="s1">&#39;simple&#39;</span><span class="p">)</span>    <span class="c1"># Detrend data again before filtering</span>
    <span class="k">if</span> <span class="n">highcut</span> <span class="ow">and</span> <span class="n">lowcut</span><span class="p">:</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Bandpassing&#39;</span><span class="p">)</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">bandpass</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">lowcut</span><span class="p">,</span> <span class="n">highcut</span><span class="p">,</span>
                           <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">,</span> <span class="n">filt_order</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">highcut</span><span class="p">:</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Lowpassing&#39;</span><span class="p">)</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">lowpass</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">highcut</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">,</span>
                          <span class="n">filt_order</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lowcut</span><span class="p">:</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Highpassing&#39;</span><span class="p">)</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">highpass</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">lowcut</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">,</span>
                           <span class="n">filt_order</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No filters applied&#39;</span><span class="p">)</span>
    <span class="c1"># Account for two letter channel names in s-files and therefore templates</span>
    <span class="k">if</span> <span class="n">seisan_chan_names</span><span class="p">:</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">padded</span><span class="p">:</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reapplying zero pads post processing&quot;</span><span class="p">)</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tr</span><span class="p">))</span>
        <span class="n">pre_pad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pre_pad_secs</span> <span class="o">*</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">))</span>
        <span class="n">post_pad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">post_pad_secs</span> <span class="o">*</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">))</span>
        <span class="n">pre_pad_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pre_pad</span><span class="p">)</span>
        <span class="n">post_pad_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">post_pad</span><span class="p">)</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Taking only valid data between </span><span class="si">{0}</span><span class="s2"> and </span><span class="si">{1}</span><span class="s2"> samples&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">pre_pad_len</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span> <span class="o">-</span> <span class="n">post_pad_len</span><span class="p">))</span>
        <span class="c1"># Re-apply the pads, taking only the data section that was valid</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span><span class="n">pre_pad</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">pre_pad_len</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">post_pad_len</span><span class="p">],</span>
             <span class="n">post_pad</span><span class="p">])</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tr</span><span class="p">))</span>
    <span class="c1"># Sanity check to ensure files are correct length</span>
    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span> <span class="o">*</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span> <span class="o">!=</span> <span class="n">length</span> <span class="ow">and</span> <span class="n">clip</span><span class="p">:</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Data for </span><span class="si">{0}</span><span class="s1"> are not of required length, will zero pad&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">tr</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="c1"># Use obspy&#39;s trim function with zero padding</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="p">,</span> <span class="n">starttime</span> <span class="o">+</span> <span class="n">length</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                     <span class="n">nearest_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># If there is one sample too many after this remove the last one</span>
        <span class="c1"># by convention</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">length</span> <span class="o">*</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">((</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span> <span class="o">-</span>
               <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Data are not required length for &#39;</span> <span class="o">+</span>
                             <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>
    <span class="c1"># Replace the gaps with zeros</span>
    <span class="k">if</span> <span class="n">gappy</span><span class="p">:</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">_zero_pad_gaps</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">gaps</span><span class="p">,</span> <span class="n">fill_gaps</span><span class="o">=</span><span class="n">fill_gaps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tr</span></div>


<span class="k">def</span> <span class="nf">_resample</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provide a pyfftw version of obspy&#39;s trace resampling.  This code is</span>
<span class="sd">    modified from obspy&#39;s Trace.resample method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">future.utils</span> <span class="kn">import</span> <span class="n">native_str</span>
    <span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">get_window</span>
    <span class="kn">from</span> <span class="nn">pyfftw.interfaces.scipy_fftpack</span> <span class="kn">import</span> <span class="n">rfft</span><span class="p">,</span> <span class="n">irfft</span>

    <span class="n">factor</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">sampling_rate</span><span class="p">)</span>
    <span class="c1"># resample in the frequency domain. Make sure the byteorder is native.</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">rfft</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">),</span> <span class="n">threads</span><span class="o">=</span><span class="n">threads</span><span class="p">)</span>
    <span class="c1"># Cast the value to be inserted to the same dtype as the array to avoid</span>
    <span class="c1"># issues with numpy rule &#39;safe&#39;.</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">x_r</span> <span class="o">=</span> <span class="n">x</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">x_i</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">large_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span>
        <span class="n">get_window</span><span class="p">(</span><span class="n">native_str</span><span class="p">(</span><span class="s2">&quot;hanning&quot;</span><span class="p">),</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span><span class="p">))</span>
    <span class="n">x_r</span> <span class="o">*=</span> <span class="n">large_w</span><span class="p">[:</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">x_i</span> <span class="o">*=</span> <span class="n">large_w</span><span class="p">[:</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># interpolate</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span> <span class="o">/</span> <span class="n">factor</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span> <span class="o">*</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
    <span class="n">d_large_f</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">num</span> <span class="o">*</span> <span class="n">sampling_rate</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">df</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">n_large_f</span> <span class="o">=</span> <span class="n">num</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">large_f</span> <span class="o">=</span> <span class="n">d_large_f</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_large_f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">large_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_large_f</span><span class="p">))</span>
    <span class="n">large_y</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">large_f</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x_r</span><span class="p">)</span>
    <span class="n">large_y</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">large_f</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x_i</span><span class="p">)</span>

    <span class="n">large_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">large_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">large_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">large_y</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">irfft</span><span class="p">(</span><span class="n">large_y</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="n">threads</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span><span class="p">))</span>
    <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="o">=</span> <span class="n">sampling_rate</span>

    <span class="k">return</span> <span class="n">tr</span>


<span class="k">def</span> <span class="nf">_zero_pad_gaps</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">gaps</span><span class="p">,</span> <span class="n">fill_gaps</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace padded parts of trace with zeros.</span>

<span class="sd">    Will cut around gaps, detrend, then pad the gaps with zeros.</span>

<span class="sd">    :type tr: :class:`osbpy.core.stream.Trace`</span>
<span class="sd">    :param tr: A trace that has had the gaps padded</span>
<span class="sd">    :param gaps: List of dict of start-time and end-time as UTCDateTime objects</span>
<span class="sd">    :type gaps: list</span>

<span class="sd">    :return: :class:`obspy.core.stream.Trace`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_in</span><span class="p">,</span> <span class="n">end_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">gap</span> <span class="ow">in</span> <span class="n">gaps</span><span class="p">:</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gap</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">:</span>
            <span class="n">stream</span> <span class="o">+=</span> <span class="n">tr</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">,</span> <span class="n">gap</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gap</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="p">:</span>
            <span class="c1"># Note this can happen when gaps are calculated for a trace that</span>
            <span class="c1"># is longer than `length`, e.g. gaps are calculated pre-trim.</span>
            <span class="n">stream</span> <span class="o">+=</span> <span class="n">tr</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">gap</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">],</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">merge</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fill_gaps</span><span class="p">:</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">()</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Need to check length - if a gap happened overlapping the end or start</span>
        <span class="c1">#  of the trace this will be lost.</span>
        <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">!=</span> <span class="n">start_in</span><span class="p">:</span>
            <span class="c1"># pad with zeros</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">-</span> <span class="n">start_in</span><span class="p">)),</span> <span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">=</span> <span class="n">start_in</span>
        <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="o">!=</span> <span class="n">end_in</span><span class="p">:</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">[</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">end_in</span> <span class="o">-</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="p">))])</span>
    <span class="k">return</span> <span class="n">tr</span>


<span class="k">def</span> <span class="nf">_fill_gaps</span><span class="p">(</span><span class="n">tr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interpolate through gaps and work-out where gaps are.</span>

<span class="sd">    :param tr: Gappy trace (e.g. tr.data is np.ma.MaskedArray)</span>
<span class="sd">    :type tr: `obspy.core.stream.Trace`</span>

<span class="sd">    :return: gaps, trace, where gaps is a list of dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">gaps</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">get_gaps</span><span class="p">()</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">()</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">gaps</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;starttime&#39;</span><span class="p">:</span> <span class="n">gap</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;endtime&#39;</span><span class="p">:</span> <span class="n">gap</span><span class="p">[</span><span class="mi">5</span><span class="p">]}</span> <span class="k">for</span> <span class="n">gap</span> <span class="ow">in</span> <span class="n">gaps</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">gaps</span><span class="p">,</span> <span class="n">tr</span>


<span class="k">def</span> <span class="nf">_prep_data_for_correlation</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">templates</span><span class="p">,</span> <span class="n">template_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">force_stream_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that all channels are the same length and that all channels have data</span>
<span class="sd">    for both template and stream.</span>

<span class="sd">    Works in place on data - will cut to shortest length</span>

<span class="sd">    :param stream: Stream to compare data to</span>
<span class="sd">    :param templates:</span>
<span class="sd">        List of streams that will be forced to have the same channels as stream</span>
<span class="sd">    :param template_names:</span>
<span class="sd">        List of strings same length as templates</span>
<span class="sd">    :type force_stream_epoch: bool</span>
<span class="sd">    :param force_stream_epoch:</span>
<span class="sd">        Whether to force all channels in stream to cover the same time period</span>

<span class="sd">    :return: stream, templates, template_names (if template_names given)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_templates</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">templates</span><span class="p">)</span>
    <span class="n">template_samp_rates</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">templates</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">template</span><span class="p">}</span>
    <span class="n">stream_samp_rates</span> <span class="o">=</span> <span class="p">{</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">}</span>
    <span class="n">samp_rates</span> <span class="o">=</span> <span class="n">template_samp_rates</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">stream_samp_rates</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">samp_rates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Sampling rates differ&quot;</span>
    <span class="n">samp_rate</span> <span class="o">=</span> <span class="n">samp_rates</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="n">out_stream</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">()</span>

    <span class="n">named</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">template_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">named</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">template_names</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_templates</span><span class="p">)</span>

    <span class="c1"># Work out shapes.</span>
    <span class="n">stream_start</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">])</span>
    <span class="n">stream_end</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">force_stream_epoch</span><span class="p">:</span>
        <span class="n">stream_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">samp_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">stream_end</span> <span class="o">-</span> <span class="n">stream_start</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stream_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">])</span>

    <span class="n">template_length</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span> <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">templates</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">template</span><span class="p">}</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">template_length</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Template traces not all the same length&quot;</span>
    <span class="n">template_length</span> <span class="o">=</span> <span class="n">template_length</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="n">stream_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">tr</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">}</span>

    <span class="c1"># Need to ensure that a channel can be in the template multiple times.</span>
    <span class="n">all_template_ids</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Counter</span><span class="p">([</span><span class="n">tr</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">template</span><span class="p">])</span> <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">]</span>
    <span class="n">template_ids</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">stream_id</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">tid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stream_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">all_template_ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">stream_id</span> <span class="ow">in</span> <span class="n">stream_ids</span><span class="p">}</span>
    <span class="n">template_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">_id</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">_id</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">template_ids</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span><span class="p">}</span>

    <span class="n">seed_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">template_ids</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">value</span><span class="p">)])</span>
    <span class="n">seed_ids</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">seed_id</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">seed_id</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">seed_id</span> <span class="ow">in</span> <span class="n">seed_ids</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">channel_number</span><span class="p">,</span> <span class="n">seed_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">template_ids</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">stream_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">stream_length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">stream_channel</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">seed_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stream_channel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Multiple channels in continuous data for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seed_id</span><span class="p">))</span>
        <span class="n">stream_channel</span> <span class="o">=</span> <span class="n">stream_channel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">stream_channel</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span> <span class="o">==</span> <span class="n">stream_length</span><span class="p">:</span>
            <span class="n">stream_data</span> <span class="o">=</span> <span class="n">stream_channel</span><span class="o">.</span><span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Data for </span><span class="si">{0}</span><span class="s1"> is not as long as needed, &#39;</span>
                        <span class="s1">&#39;padding&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_channel</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">force_stream_epoch</span><span class="p">:</span>
                <span class="n">start_pad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">samp_rate</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="n">stream_channel</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">-</span> <span class="n">stream_start</span><span class="p">))</span>
                <span class="n">end_pad</span> <span class="o">=</span> <span class="n">stream_length</span> <span class="o">-</span> <span class="p">(</span>
                        <span class="n">start_pad</span> <span class="o">+</span> <span class="n">stream_channel</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span><span class="p">)</span>
                <span class="c1"># In some cases there will be one sample missing when sampling</span>
                <span class="c1"># time-stamps are not set consistently between channels, this</span>
                <span class="c1"># results in start_pad and end_pad being len==0</span>
                <span class="k">if</span> <span class="n">start_pad</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">end_pad</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Start and end pad are both zero, padding &quot;</span>
                                 <span class="s2">&quot;at one end&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">stream_channel</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">-</span> <span class="n">stream_start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span>
                       <span class="n">stream_end</span> <span class="o">-</span> <span class="n">stream_channel</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="p">):</span>
                        <span class="n">start_pad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                            <span class="n">stream_length</span> <span class="o">-</span> <span class="n">stream_channel</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">end_pad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                            <span class="n">stream_length</span> <span class="o">-</span> <span class="n">stream_channel</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span><span class="p">)</span>
                <span class="n">stream_channel</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">-=</span> <span class="p">(</span><span class="n">start_pad</span> <span class="o">/</span> <span class="n">samp_rate</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start_pad</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">end_pad</span> <span class="o">=</span> <span class="n">stream_length</span> <span class="o">-</span> <span class="n">stream_channel</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">npts</span>
            <span class="k">if</span> <span class="n">end_pad</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">stream_data</span><span class="p">[</span><span class="n">start_pad</span><span class="p">:]</span> <span class="o">=</span> <span class="n">stream_channel</span><span class="o">.</span><span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stream_data</span><span class="p">[</span><span class="n">start_pad</span><span class="p">:</span><span class="o">-</span><span class="n">end_pad</span><span class="p">]</span> <span class="o">=</span> <span class="n">stream_channel</span><span class="o">.</span><span class="n">data</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">stream_channel</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">header</span><span class="o">.</span><span class="n">npts</span> <span class="o">=</span> <span class="n">stream_length</span>
        <span class="n">out_stream</span> <span class="o">+=</span> <span class="n">Trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">stream_data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>

    <span class="c1"># Initialize nan template for speed.</span>
    <span class="n">nan_channel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">template_length</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">nan_template</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_seed_id</span> <span class="ow">in</span> <span class="n">seed_ids</span><span class="p">:</span>
        <span class="n">net</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">_seed_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">nan_template</span> <span class="o">+=</span> <span class="n">Trace</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">Stats</span><span class="p">({</span>
            <span class="s1">&#39;network&#39;</span><span class="p">:</span> <span class="n">net</span><span class="p">,</span> <span class="s1">&#39;station&#39;</span><span class="p">:</span> <span class="n">sta</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">loc</span><span class="p">,</span>
            <span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="n">chan</span><span class="p">,</span> <span class="s1">&#39;starttime&#39;</span><span class="p">:</span> <span class="n">UTCDateTime</span><span class="p">(),</span>
            <span class="s1">&#39;npts&#39;</span><span class="p">:</span> <span class="n">template_length</span><span class="p">,</span> <span class="s1">&#39;sampling_rate&#39;</span><span class="p">:</span> <span class="n">samp_rate</span><span class="p">}))</span>

    <span class="c1"># Remove templates with no matching channels</span>
    <span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">template_names</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">template</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">templates</span><span class="p">):</span>
        <span class="n">trace_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">tr</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">template</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trace_ids</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">stream_ids</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">filt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">_out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
        <span class="p">[</span><span class="n">_tn</span> <span class="k">for</span> <span class="n">_tn</span><span class="p">,</span> <span class="n">_filt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">template_names</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span> <span class="k">if</span> <span class="n">_filt</span><span class="p">],</span>
        <span class="p">[</span><span class="n">_t</span> <span class="k">for</span> <span class="n">_t</span><span class="p">,</span> <span class="n">_filt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span> <span class="k">if</span> <span class="n">_filt</span><span class="p">]))</span>
    <span class="n">flt_templates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_out</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_out</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">templates</span><span class="p">):</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Some templates not used due to no matching channels&quot;</span><span class="p">)</span>

    <span class="c1"># Ensure that the templates&#39; earliest traces are kept, even if there is no</span>
    <span class="c1"># continuous data for them. If this happens, we need to add a NaN-stream to</span>
    <span class="c1"># the continuous data to avoid inconsistent detection times.</span>
    <span class="n">n_template_traces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="k">for</span> <span class="n">temp</span> <span class="ow">in</span> <span class="n">flt_templates</span><span class="p">])</span>
    <span class="n">n_stream_traces</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">seed_ids</span><span class="p">])</span>
    <span class="c1"># These checks are not necessary if all templates will get NaN-traces,</span>
    <span class="c1"># because the NaN-traces will save the right starttime for the template.</span>
    <span class="n">nan_stream_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">n_template_traces</span> <span class="o">&gt;</span> <span class="n">n_stream_traces</span><span class="p">):</span>
        <span class="n">earliest_templ_trace_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">[</span><span class="n">template</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s1">&#39;starttime&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">flt_templates</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">earliest_templ_trace_id</span> <span class="ow">in</span> <span class="n">earliest_templ_trace_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">earliest_templ_trace_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">template_ids</span><span class="p">:</span>
                <span class="n">nan_stream_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">earliest_templ_trace_id</span><span class="p">)</span>
                <span class="n">net</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">earliest_templ_trace_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="n">nan_template</span> <span class="o">+=</span> <span class="n">Trace</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">Stats</span><span class="p">({</span>
                    <span class="s1">&#39;network&#39;</span><span class="p">:</span> <span class="n">net</span><span class="p">,</span> <span class="s1">&#39;station&#39;</span><span class="p">:</span> <span class="n">sta</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">loc</span><span class="p">,</span>
                    <span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="n">chan</span><span class="p">,</span> <span class="s1">&#39;starttime&#39;</span><span class="p">:</span> <span class="n">UTCDateTime</span><span class="p">(),</span>
                    <span class="s1">&#39;npts&#39;</span><span class="p">:</span> <span class="n">template_length</span><span class="p">,</span> <span class="s1">&#39;sampling_rate&#39;</span><span class="p">:</span> <span class="n">samp_rate</span><span class="p">}))</span>
                <span class="n">stream_nan_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                    <span class="n">stream_length</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">out_stream</span> <span class="o">+=</span> <span class="n">Trace</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">stream_nan_data</span><span class="p">,</span> <span class="n">stream_nan_data</span><span class="p">),</span>
                    <span class="n">header</span><span class="o">=</span><span class="n">Stats</span><span class="p">({</span>
                        <span class="s1">&#39;network&#39;</span><span class="p">:</span> <span class="n">net</span><span class="p">,</span> <span class="s1">&#39;station&#39;</span><span class="p">:</span> <span class="n">sta</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">loc</span><span class="p">,</span>
                        <span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="n">chan</span><span class="p">,</span> <span class="s1">&#39;starttime&#39;</span><span class="p">:</span> <span class="n">stream_start</span><span class="p">,</span>
                        <span class="s1">&#39;npts&#39;</span><span class="p">:</span> <span class="n">stream_length</span><span class="p">,</span> <span class="s1">&#39;sampling_rate&#39;</span><span class="p">:</span> <span class="n">samp_rate</span><span class="p">}))</span>
                <span class="n">seed_ids</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">earliest_templ_trace_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="n">incomplete_templates</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">template_name</span> <span class="k">for</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">_out</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span>
        <span class="nb">sorted</span><span class="p">([</span><span class="n">tr</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">template</span><span class="p">])</span> <span class="o">!=</span> <span class="p">[</span><span class="n">tr</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">nan_template</span><span class="p">]}</span>

    <span class="c1"># Fill out the templates with nan channels</span>
    <span class="k">for</span> <span class="n">template_name</span> <span class="ow">in</span> <span class="n">incomplete_templates</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">_out</span><span class="p">[</span><span class="n">template_name</span><span class="p">]</span>
        <span class="n">template_starttime</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">template</span><span class="p">)</span>
        <span class="n">out_template</span> <span class="o">=</span> <span class="n">nan_template</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">channel_number</span><span class="p">,</span> <span class="n">_seed_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seed_ids</span><span class="p">):</span>
            <span class="n">seed_id</span><span class="p">,</span> <span class="n">channel_index</span> <span class="o">=</span> <span class="n">_seed_id</span>
            <span class="n">template_channel</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">seed_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">template_channel</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">channel_index</span><span class="p">:</span>
                <span class="n">out_template</span><span class="p">[</span><span class="n">channel_number</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">nan_channel</span>
                <span class="n">out_template</span><span class="p">[</span><span class="n">channel_number</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">=</span> \
                    <span class="n">template_starttime</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_template</span><span class="p">[</span><span class="n">channel_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">template_channel</span><span class="p">[</span><span class="n">channel_index</span><span class="p">]</span>
        <span class="c1"># If a template-trace matches a NaN-trace in the stream , then set</span>
        <span class="c1"># template-trace to NaN so that this trace does not appear in channel-</span>
        <span class="c1"># list of detections.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nan_stream_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">out_template</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">nan_stream_ids</span><span class="p">:</span>
                    <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">nan_channel</span>
        <span class="n">_out</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">template_name</span><span class="p">:</span> <span class="n">out_template</span><span class="p">})</span>

    <span class="n">out_templates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_out</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">out_template_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_out</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">named</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">out_stream</span><span class="p">,</span> <span class="n">out_templates</span><span class="p">,</span> <span class="n">out_template_names</span>
    <span class="k">return</span> <span class="n">out_stream</span><span class="p">,</span> <span class="n">out_templates</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>
    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2015-2021: EQcorrscan developers.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.2.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>