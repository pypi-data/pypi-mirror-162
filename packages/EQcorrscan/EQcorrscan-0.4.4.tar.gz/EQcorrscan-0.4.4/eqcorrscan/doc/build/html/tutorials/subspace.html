<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

    <title>4.5. Subspace Detection &#8212; EQcorrscan 0.4.3 documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="shortcut icon" href="../_static/EQcorrscan_logo.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4.6. Lag-time and pick correction" href="lag-calc.html" />
    <link rel="prev" title="4.4. Template creation (old API)" href="template-creation.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.12.4.min.js "></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../_static/bootstrap-3.4.1/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html"><span><img src="../_static/EQcorrscan_logo.jpg"></span>
          EQcorrscan</a>
        <span class="navbar-text navbar-version pull-left"><b>0.4</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">1. Introduction to the EQcorrscan package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">2. EQcorrscan installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../updates.html">3. What’s new</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorial.html">4. EQcorrscan tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">5. EQcorrscan API</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">4.5. Subspace Detection</a><ul>
<li><a class="reference internal" href="#warning">4.5.1. WARNING</a></li>
<li><a class="reference internal" href="#important">4.5.2. Important</a></li>
<li><a class="reference internal" href="#simple-example">4.5.3. Simple example</a></li>
<li><a class="reference internal" href="#advanced-example">4.5.4. Advanced Example</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="template-creation.html" title="Previous Chapter: 4.4. Template creation (old API)"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 4.4. Template...</span>
    </a>
  </li>
  <li>
    <a href="lag-calc.html" title="Next Chapter: 4.6. Lag-time and pick correction"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">4.6. Lag-time... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/tutorials/subspace.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <section id="subspace-detection">
<h1><span class="section-number">4.5. </span>Subspace Detection<a class="headerlink" href="#subspace-detection" title="Permalink to this headline">¶</a></h1>
<p>EQcorrscan’s subspace detection methods are closely modelled on the method
described by <a href="https://e-reports-ext.llnl.gov/pdf/335299.pdf" target="_blank">Harris (2006)</a>, Subspace Detectors: Theory.  We offer options to
multiplex data or leave as single-channels (multiplexing is significantly
faster).</p>
<p>Subspace detection is implemented in an object-oriented style, whereby individual
detectors are constructed from data, then used to detect within continuous data.
At the core of the subspace routine is a Cython-based, static-typed routine to
calculate the detection statistics.  We do this to make use of numpy’s vectorized
calculations, while taking advantage of the speed-ups afforded by compiling
the sliding window loop.</p>
<section id="warning">
<h2><span class="section-number">4.5.1. </span>WARNING<a class="headerlink" href="#warning" title="Permalink to this headline">¶</a></h2>
<p>Subspace in EQcorrscan is in <strong>beta</strong>, you must check your results match what
you expect - if you find errors please report them.  Although our test-cases run
correctly, changes in data quality may affect the routines in ways we have not
accounted for.</p>
</section>
<section id="important">
<h2><span class="section-number">4.5.2. </span>Important<a class="headerlink" href="#important" title="Permalink to this headline">¶</a></h2>
<p>How you generate you detector is likely to be the most important thing, careful
selection and alignment is key, and because of this we haven’t provided a total
<em>cookie-cutter</em> system for doing this.  You have freedom to chose your parameters,
how to process, how you align, what traces to keep, whether you multiplex or not,
etc.  This also means you have a lot of freedom to <strong>get it wrong</strong>. You will
have to do significant testing with your own dataset to work out what works and
what doesn’t.  Anything that you find that doesn’t work well in EQcorrscans
system, it would be great to hear about so that we can make it better.</p>
<p>The following examples demonstrate some of the options, but not all of them.
The advanced example is the example used to test and develop subspace and took
a fair amount of effort over a number of weeks.</p>
</section>
<section id="simple-example">
<h2><span class="section-number">4.5.3. </span>Simple example<a class="headerlink" href="#simple-example" title="Permalink to this headline">¶</a></h2>
<p>To begin with you will need to create a <strong>Detector</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">eqcorrscan.core</span> <span class="kn">import</span> <span class="n">subspace</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">detector</span> <span class="o">=</span> <span class="n">subspace</span><span class="o">.</span><span class="n">Detector</span><span class="p">()</span>
</pre></div>
</div>
<p>This will create an empty <em>detector</em> object.  These objects have various attributes,
including the data to be used as a detector (<em>detector.data</em>), alongside the full
input and output basis vector matrices (<em>detector.u</em> and <em>detector.v</em> respectively)
and the vector of singular-values (<em>detector.sigma</em>).  Meta-data are also included,
including whether the detector is multiplexed or not (<em>detector.multiplex</em>), the
filters applied (<em>detector.lowcut</em>, <em>detector.highcut</em>, <em>detection.filt_order</em>,
<em>detector.sampling_rate</em>), the dimension of the subspace (<em>detector.dimension</em>),
and the name of the detector, which you can use for book-keeping
(<em>detector.name</em>).</p>
<p>To populate the empty detector you need a design set of streams that have been
aligned (see clustering submodule for alignment methods).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">obspy</span> <span class="kn">import</span> <span class="n">read</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">glob</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">os</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">eqcorrscan</span> <span class="kn">import</span> <span class="n">tests</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Get the path for the test-data so we can test this</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">TEST_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">tests</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">wavefiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
<span class="gp">... </span>   <span class="n">TEST_PATH</span> <span class="o">+</span> <span class="s1">&#39;/test_data/similar_events_processed/*&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">wavefiles</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># Sort the wavefiles to ensure reproducibility</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">streams</span> <span class="o">=</span> <span class="p">[</span><span class="n">read</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">wavefiles</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Channels must all be the same length</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">detector</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="n">streams</span><span class="o">=</span><span class="n">streams</span><span class="p">,</span> <span class="n">lowcut</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">highcut</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">filt_order</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">sampling_rate</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">multiplex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Test_1&#39;</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shift_len</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">reject</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="go">Detector: Test_1</span>
</pre></div>
</div>
<p>This will populate all the attributes of your <em>detector</em> object, and fill the
<em>detector.data</em> with the full input basis vector matrix.</p>
<p>You will want to reduce the dimensions of your subspace detector, such that
you are just describing the signal, preferably with a lot of generality.  Details
for selecting dimensionality should be found in <a href="https://e-reports-ext.llnl.gov/pdf/335299.pdf" target="_blank">Harris (2006)</a>.  To do this in
EQcorrscan simply use the <em>partition</em> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">detector</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">Detector: Test_1</span>
</pre></div>
</div>
<p>This will populate <em>detector.data</em> with the first four, left-most input basis
vectors.  You can test to see how much of your original design set is
described by this detector by using the <em>energy_capture</em> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">percent_capture</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">energy_capture</span><span class="p">()</span>
</pre></div>
</div>
<p>This will return a percentage capture, you can run this for multiple dimensions
to test what dimension best suits your application.  Again, details for this
selection can be found in <a href="https://e-reports-ext.llnl.gov/pdf/335299.pdf" target="_blank">Harris (2006)</a>.</p>
<p>Finally, to use your detector to detect within continuous data you should use
the <em>detect</em> method.  This requires a stream with the same stations and channels
used in the detector, and a threshold from 0-1, where 0 is no signal, and 1 is
totally described by your detector.  You can extract streams for the detections
at the same time as the detections by setting the extract_detections flag to
True.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stream</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">wavefiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">detections</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">st</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">trig_int</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> 
</pre></div>
</div>
</section>
<section id="advanced-example">
<h2><span class="section-number">4.5.4. </span>Advanced Example<a class="headerlink" href="#advanced-example" title="Permalink to this headline">¶</a></h2>
<p>This example computes detections for a short data-period during an earthquake
sequence in the Wairarapa region of New Zealand’s North Island.  This example only
shows one subspace detector, but could be extended, using the various <a class="reference internal" href="../submodules/utils.clustering.html"><span class="doc">clustering</span></a>
routines in EQcorrscan, to create many subspace detectors.  These could be run
using the <a class="reference internal" href="../submodules/autogen/eqcorrscan.core.subspace.subspace_detect.html"><span class="doc">subspace_detect</span></a>
function, which runs similar
detectors in parallel through the given data.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Advanced subspace tutorial to show some of the capabilities of the method.</span>

<span class="sd">This example uses waveforms from a known earthquake sequence (in the Wairarapa</span>
<span class="sd">region north of Wellington, New Zealand). The catalogue locations etc can</span>
<span class="sd">be downloaded from this link:</span>

<span class="sd">http://quakesearch.geonet.org.nz/services/1.0.0/csv?bbox=175.37956,-40.97912,175.53097,-40.84628&amp;startdate=2015-7-18T2:00:00&amp;enddate=2016-7-18T3:00:00</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">http.client</span> <span class="kn">import</span> <span class="n">IncompleteRead</span>
<span class="kn">from</span> <span class="nn">obspy.clients.fdsn</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">obspy</span> <span class="kn">import</span> <span class="n">UTCDateTime</span><span class="p">,</span> <span class="n">Stream</span>

<span class="kn">from</span> <span class="nn">eqcorrscan.utils.catalog_utils</span> <span class="kn">import</span> <span class="n">filter_picks</span>
<span class="kn">from</span> <span class="nn">eqcorrscan.utils.clustering</span> <span class="kn">import</span> <span class="n">catalog_cluster</span>
<span class="kn">from</span> <span class="nn">eqcorrscan.core</span> <span class="kn">import</span> <span class="n">subspace</span>

<span class="c1"># Set up logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="se">\t</span><span class="si">%(name)s</span><span class="se">\t</span><span class="si">%(levelname)s</span><span class="se">\t</span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">run_tutorial</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multiplex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_streams</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the tutorial.</span>

<span class="sd">    :return: detections</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="s2">&quot;GEONET&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_events</span><span class="p">(</span>
        <span class="n">minlatitude</span><span class="o">=-</span><span class="mf">40.98</span><span class="p">,</span> <span class="n">maxlatitude</span><span class="o">=-</span><span class="mf">40.85</span><span class="p">,</span> <span class="n">minlongitude</span><span class="o">=</span><span class="mf">175.4</span><span class="p">,</span>
        <span class="n">maxlongitude</span><span class="o">=</span><span class="mf">175.5</span><span class="p">,</span> <span class="n">starttime</span><span class="o">=</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">endtime</span><span class="o">=</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded a catalog of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span><span class="si">}</span><span class="s2"> events&quot;</span><span class="p">)</span>
    <span class="c1"># This gives us a catalog of events - it takes a while to download all</span>
    <span class="c1"># the information, so give it a bit!</span>
    <span class="c1"># We will generate a five station, multi-channel detector.</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">filter_picks</span><span class="p">(</span><span class="n">catalog</span><span class="o">=</span><span class="n">cat</span><span class="p">,</span> <span class="n">top_n_picks</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">stachans</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span>
        <span class="p">[(</span><span class="n">pick</span><span class="o">.</span><span class="n">waveform_id</span><span class="o">.</span><span class="n">station_code</span><span class="p">,</span> <span class="n">pick</span><span class="o">.</span><span class="n">waveform_id</span><span class="o">.</span><span class="n">channel_code</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">cat</span> <span class="k">for</span> <span class="n">pick</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">picks</span><span class="p">]))</span>
    <span class="c1"># In this tutorial we will only work on one cluster, defined spatially.</span>
    <span class="c1"># You can work on multiple clusters, or try to whole set.</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">catalog_cluster</span><span class="p">(</span>
        <span class="n">catalog</span><span class="o">=</span><span class="n">cat</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;distance&quot;</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># We will work on the largest cluster</span>
    <span class="n">cluster</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># This cluster contains 32 events, we will now download and trim the</span>
    <span class="c1"># waveforms.  Note that each chanel must start at the same time and be the</span>
    <span class="c1"># same length for multiplexing.  If not multiplexing EQcorrscan will</span>
    <span class="c1"># maintain the individual differences in time between channels and delay</span>
    <span class="c1"># the detection statistics by that amount before stacking and detection.</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="s1">&#39;GEONET&#39;</span><span class="p">)</span>
    <span class="n">design_set</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading for event </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">resource_id</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">bulk_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">origins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">+</span> <span class="mf">25.1</span>  <span class="c1"># Have to download extra data, otherwise GeoNet will</span>
        <span class="c1"># trim wherever suits.</span>
        <span class="n">t1</span> <span class="o">-=</span> <span class="mf">0.1</span>
        <span class="k">for</span> <span class="n">station</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">stachans</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">+=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_waveforms</span><span class="p">(</span>
                    <span class="s1">&#39;NZ&#39;</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">IncompleteRead</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not download for </span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span><span class="si">}</span><span class="s2"> channels&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">origins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">+</span> <span class="mi">25</span>
        <span class="n">design_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">))</span>
    <span class="c1"># Construction of the detector will process the traces, then align them,</span>
    <span class="c1"># before multiplexing.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Making detector&quot;</span><span class="p">)</span>
    <span class="n">detector</span> <span class="o">=</span> <span class="n">subspace</span><span class="o">.</span><span class="n">Detector</span><span class="p">()</span>
    <span class="n">detector</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span>
        <span class="n">streams</span><span class="o">=</span><span class="n">design_set</span><span class="p">,</span> <span class="n">lowcut</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">highcut</span><span class="o">=</span><span class="mf">9.0</span><span class="p">,</span> <span class="n">filt_order</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">sampling_rate</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">multiplex</span><span class="o">=</span><span class="n">multiplex</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Wairarapa1&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">reject</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">shift_len</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">)</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Constructed Detector&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">detector</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
    <span class="c1"># We also want the continuous stream to detect in.</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">19</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="c1"># We are going to look in a single hour just to minimize cost, but you can</span>
    <span class="c1"># run for much longer.</span>
    <span class="n">bulk_info</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;NZ&#39;</span><span class="p">,</span> <span class="n">stachan</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span>
                  <span class="n">stachan</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="n">stachan</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                  <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span> <span class="k">for</span> <span class="n">stachan</span> <span class="ow">in</span> <span class="n">detector</span><span class="o">.</span><span class="n">stachans</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading continuous data&quot;</span><span class="p">)</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_waveforms_bulk</span><span class="p">(</span><span class="n">bulk_info</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="s1">&#39;simple&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">t1</span><span class="p">,</span> <span class="n">endtime</span><span class="o">=</span><span class="n">t2</span><span class="p">)</span>
    <span class="c1"># We set a very low threshold because the detector is not that great, we</span>
    <span class="c1"># haven&#39;t aligned it particularly well - however, at this threshold we make</span>
    <span class="c1"># two real detections.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing detections&quot;</span><span class="p">)</span>
    <span class="n">detections</span><span class="p">,</span> <span class="n">det_streams</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span>
        <span class="n">st</span><span class="o">=</span><span class="n">st</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">trig_int</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">extract_detections</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cores</span><span class="o">=</span><span class="n">cores</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_streams</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">detections</span><span class="p">,</span> <span class="n">det_streams</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">detections</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">run_tutorial</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2015-2021: EQcorrscan developers.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.2.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>